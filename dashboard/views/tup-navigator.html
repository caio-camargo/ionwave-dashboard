<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TUP Navigator - IonWave</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>

  <header class="header">
    <div class="header-left">
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
        <path d="M2 18 Q7 10 14 14 Q21 18 26 10" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" fill="none"/>
        <path d="M2 14 Q7 6 14 10 Q21 14 26 6" stroke="#22c55e" stroke-width="2" stroke-linecap="round" fill="none" opacity="0.5"/>
      </svg>
      <h1 class="header-title">TUP NAVIGATOR</h1>
    </div>
    <div class="header-right">
      <div class="header-meta">
        <span class="header-meta-label">Passet:</span>
        <span class="badge badge-info">Imagination</span>
      </div>
      <div class="header-meta">
        <span class="header-meta-label">Level:</span>
        <span class="badge badge-success">Business</span>
      </div>
    </div>
  </header>

  <nav class="nav-bar">
    <a href="../index.html">Mission Control</a>
    <a href="tup-navigator.html" class="active">üó∫Ô∏è TUP Navigator</a>
    <a href="hypotheses-tracker.html">üß™ Hypotheses Tracker</a>
    <a href="financial-forecast.html">üìä Financial Forecast</a>
    <a href="m0-trade-thesis.html">M0 Trade Thesis</a>
    <a href="m26-competitive-intel.html">M26 Competitive Intel</a>
    <a href="m27-customer-research.html">M27 Customer Research</a>
  </nav>

  <!-- Stats Ribbon -->
  <div id="stats-ribbon" class="stats-ribbon">
    <div class="loading">Loading crosswalk...</div>
  </div>

  <div class="page-content">

    <!-- Ontological Primitives -->
    <div class="section-divider">
      <h2 class="section-title">Ontological Primitives</h2>
    </div>

    <div class="section-grid grid-3" id="ontology-cards">
      <div class="card">
        <div class="card-header">
          <span>TUP</span>
          <span class="badge badge-info">103 defined</span>
        </div>
        <div class="card-body">
          <p style="font-size:var(--font-size-xs); color:var(--text-secondary);">Trade Unit Project. Fundamental unit of knowledge. Contains project plan, contract, industry perspectives, verification, and content tabs.</p>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span>Hypothesis</span>
          <span class="badge badge-review">8 active</span>
        </div>
        <div class="card-body">
          <p style="font-size:var(--font-size-xs); color:var(--text-secondary);">Falsifiable assumption with confidence grade, evidence base, and kill threshold. The primary epistemic unit.</p>
          <a href="hypotheses-tracker.html" style="display:block; margin-top:var(--gap-sm); font-size:var(--font-size-xs); color:var(--color-info);">View Tracker &rarr;</a>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span>Controller</span>
          <span class="badge badge-warning">Formalized</span>
        </div>
        <div class="card-body">
          <p style="font-size:var(--font-size-xs); color:var(--text-secondary);">Feedback mechanism with parameters (thresholds), metrics (measured values), and reactive protocols (responses). Severity: Early Warning &rarr; Bifurcation &rarr; Kill.</p>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span>Observer</span>
          <span class="badge badge-warning">Formalized</span>
        </div>
        <div class="card-body">
          <p style="font-size:var(--font-size-xs); color:var(--text-secondary);">Composite state estimator combining multiple signals into weighted scores with diagnostic fault-trees. E.g., Computational PMF (10 signals).</p>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span>OpKit</span>
          <span class="badge badge-warning">Formalized</span>
        </div>
        <div class="card-body">
          <p style="font-size:var(--font-size-xs); color:var(--text-secondary);">Collection of documents scaffolding deliverable generation. Contains reference models, templates, and checklists. Associated per-TUP.</p>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span>Metric</span>
          <span class="badge badge-warning">Formalized</span>
        </div>
        <div class="card-body">
          <p style="font-size:var(--font-size-xs); color:var(--text-secondary);">Individual formalized measure feeding Controllers and Observers. Has defined source, frequency, and interpretation rules.</p>
        </div>
      </div>
    </div>

    <!-- Cluster Map -->
    <div class="section-divider">
      <h2 class="section-title">Business Level Clusters</h2>
    </div>

    <div id="clusters-container" class="section-grid grid-2">
      <div class="loading">Loading clusters...</div>
    </div>

    <!-- TUP Detail (shown when a cluster is expanded) -->
    <div class="section-divider">
      <h2 class="section-title">All TUPs by Cluster</h2>
    </div>

    <div id="tups-container">
      <div class="loading">Loading TUP data...</div>
    </div>

    <!-- Reconciliation Summary -->
    <div class="section-divider">
      <h2 class="section-title">Reconciliation Status</h2>
    </div>

    <div id="recon-container" class="section-grid grid-2">
      <div class="loading">Loading decisions...</div>
    </div>

  </div>

  <footer class="footer">
    IonWave Mission Control &middot; Trade #84 &middot;
    <a href="../index.html">&larr; Back to Mission Control</a>
  </footer>

  <script src="../js/data-loader.js"></script>
  <script src="../js/renderers.js"></script>
  <script>
    // ‚îÄ‚îÄ Cluster color map ‚îÄ‚îÄ
    const CLUSTER_COLORS = {
      'BCL-0': { accent: 'var(--color-info)',    bg: 'var(--color-info-bg)',    label: 'Thesis & Meta' },
      'BCL-1': { accent: 'var(--color-success)',  bg: 'var(--color-success-bg)', label: 'Product & Science' },
      'BCL-2': { accent: 'var(--color-critical)', bg: 'var(--color-critical-bg)',label: 'Money & Legal' },
      'BCL-3': { accent: 'var(--color-review)',   bg: 'var(--color-review-bg)',  label: 'DR & Creative' },
      'BCL-4': { accent: 'var(--color-warning)',  bg: 'var(--color-warning-bg)', label: 'Retention & Lifecycle' },
      'BCL-5': { accent: '#06b6d4',              bg: '#042f2e',                 label: 'Growth & Market' },
      'BCL-6': { accent: '#64748b',              bg: '#1e293b',                 label: 'Operations & Infra' },
      'BCL-7': { accent: '#f472b6',              bg: '#500724',                 label: 'Governance & School' }
    };

    const DECISION_BADGES = {
      'MERGE': 'badge-info',
      'DANILO CANON': 'badge-success',
      'PENDING': 'badge-critical',
      'DEFER': 'badge-neutral'
    };

    function getDecisionType(decisionStr) {
      if (!decisionStr) return 'PENDING';
      if (decisionStr.includes('MERGE')) return 'MERGE';
      if (decisionStr.includes('DANILO CANON')) return 'DANILO CANON';
      if (decisionStr.includes('DEFER')) return 'DEFER';
      if (decisionStr.includes('PENDING')) return 'PENDING';
      return 'PENDING';
    }

    function fileIdToViewPath(fileId) {
      return fileId.replace(/_/g, '-') + '.html';
    }

    document.addEventListener('DOMContentLoaded', async function() {
      // Load both crosswalk and manifest in parallel
      const [crosswalk, manifest] = await Promise.all([
        DataLoader.load('crosswalk.json'),
        DataLoader.loadManifest()
      ]);

      if (!crosswalk || !manifest) {
        document.getElementById('stats-ribbon').innerHTML =
          '<div class="stat-box accent-critical"><div class="stat-value">!</div><div class="stat-label">Failed to load data</div></div>';
        return;
      }

      // ‚îÄ‚îÄ Stats Ribbon ‚îÄ‚îÄ
      const clusterCount = Object.keys(crosswalk.clusters).length;
      const tupCount = Object.keys(crosswalk.tup_to_files).length;
      const fileCount = Object.keys(crosswalk.file_to_tup).length;
      const resolvedCount = Object.values(crosswalk.clusters)
        .filter(c => !c.decision.includes('PENDING')).length;
      const unmappedTups = crosswalk.unmapped.tups_without_bootstrap_file.length;

      document.getElementById('stats-ribbon').innerHTML = `
        <div class="stat-box accent-info">
          <div class="stat-value">${clusterCount}</div>
          <div class="stat-label">Clusters</div>
        </div>
        <div class="stat-box accent-success">
          <div class="stat-value">${tupCount}</div>
          <div class="stat-label">Business TUPs</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">${fileCount}</div>
          <div class="stat-label">Bootstrap Files</div>
        </div>
        <div class="stat-box accent-success">
          <div class="stat-value">${resolvedCount}/${clusterCount}</div>
          <div class="stat-label">Decisions Resolved</div>
        </div>
        <div class="stat-box accent-warning">
          <div class="stat-value">${unmappedTups}</div>
          <div class="stat-label">Unmapped TUPs</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">103</div>
          <div class="stat-label">Total TUPs (All Levels)</div>
        </div>
      `;

      // ‚îÄ‚îÄ Cluster Cards ‚îÄ‚îÄ
      const clustersEl = document.getElementById('clusters-container');
      let clustersHtml = '';

      for (const [clusterId, cluster] of Object.entries(crosswalk.clusters)) {
        const colors = CLUSTER_COLORS[clusterId] || CLUSTER_COLORS['BCL-6'];
        const decisionType = getDecisionType(cluster.decision);
        const decisionBadge = DECISION_BADGES[decisionType] || 'badge-neutral';
        const tupCount = cluster.tups.length;

        // Count files mapped to this cluster
        const clusterFiles = Object.entries(crosswalk.file_to_tup)
          .filter(([_, mapping]) => mapping.cluster === clusterId);

        // Get migration stats from manifest
        const migratedFiles = clusterFiles.filter(([fileId]) => {
          const f = manifest.files[fileId];
          return f && (f.status === 'migrated' || f.status === 'migrating');
        });

        clustersHtml += `
          <div class="card cluster-card" style="border-left: 3px solid ${colors.accent};">
            <div class="card-header" style="background: ${colors.bg};">
              <span style="font-weight:600; color:${colors.accent};">${clusterId}: ${Renderers.escapeHtml(cluster.name)}</span>
              <span class="badge ${decisionBadge}">${decisionType}</span>
            </div>
            <div class="card-body">
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:var(--gap-sm); font-size:var(--font-size-xs); margin-bottom:var(--gap-sm);">
                <div>
                  <span style="color:var(--text-dim);">TUPs:</span>
                  <span style="color:var(--text-primary); font-weight:600;">${tupCount}</span>
                  <span style="color:var(--text-dim); margin-left:4px;">(${cluster.tups.join(', ')})</span>
                </div>
                <div>
                  <span style="color:var(--text-dim);">Files:</span>
                  <span style="color:var(--text-primary); font-weight:600;">${clusterFiles.length}</span>
                  <span style="color:var(--text-dim); margin-left:4px;">(${migratedFiles.length} migrated)</span>
                </div>
              </div>
              <div style="font-size:var(--font-size-xs); color:var(--text-dim); margin-bottom:var(--gap-sm);">
                <span style="color:var(--text-dim);">Owner:</span> ${Renderers.escapeHtml(cluster.owner)}
              </div>
              <div style="font-size:var(--font-size-xs); color:var(--text-dim);">
                <span style="color:var(--text-dim);">Decision:</span> ${Renderers.escapeHtml(cluster.decision)}
              </div>
              ${clusterFiles.length > 0 ? `
                <div style="display:flex; flex-wrap:wrap; gap:var(--gap-xs); margin-top:var(--gap-sm);">
                  ${clusterFiles.map(([fileId]) => {
                    const f = manifest.files[fileId];
                    const title = f ? f.title : fileId;
                    const hasView = f && (f.status === 'migrated' || f.status === 'migrating');
                    if (hasView) {
                      return `<a href="${fileIdToViewPath(fileId)}" class="dep-tag" style="font-size:0.65rem;">${Renderers.escapeHtml(title)}</a>`;
                    }
                    return `<span class="dep-tag" style="font-size:0.65rem;">${Renderers.escapeHtml(title)}</span>`;
                  }).join('')}
                </div>
              ` : ''}
            </div>
          </div>`;
      }

      clustersEl.innerHTML = clustersHtml;

      // ‚îÄ‚îÄ TUPs by Cluster (detailed) ‚îÄ‚îÄ
      const tupsEl = document.getElementById('tups-container');
      let tupsHtml = '';

      for (const [clusterId, cluster] of Object.entries(crosswalk.clusters)) {
        const colors = CLUSTER_COLORS[clusterId] || CLUSTER_COLORS['BCL-6'];

        tupsHtml += `
          <div class="collapsible" data-expanded="true" style="margin-bottom:var(--gap-md);">
            <div class="card-header collapsible-toggle"
                 style="background:${colors.bg}; border:1px solid ${colors.accent}; border-radius:var(--radius-md); cursor:pointer; padding:var(--gap-sm) var(--gap-md);"
                 onclick="this.parentElement.dataset.expanded = this.parentElement.dataset.expanded === 'true' ? 'false' : 'true';">
              <span>
                <span class="toggle-chevron">&#9660;</span>
                <span style="color:${colors.accent}; font-weight:600;">${clusterId}</span>
                <span style="color:var(--text-secondary); margin-left:var(--gap-sm);">${Renderers.escapeHtml(cluster.name)}</span>
              </span>
              <span style="font-size:var(--font-size-xs); color:var(--text-dim);">${cluster.tups.length} TUPs</span>
            </div>
            <div class="collapsible-content" style="max-height:2000px;">
              <table class="data-table" style="margin-top:var(--gap-sm);">
                <thead>
                  <tr>
                    <th style="width:60px;">TUP</th>
                    <th>Name</th>
                    <th>Bootstrap Files</th>
                    <th style="width:80px;">Status</th>
                  </tr>
                </thead>
                <tbody>
                  ${cluster.tups.map(tupCode => {
                    const tup = crosswalk.tup_to_files[tupCode];
                    if (!tup) return '';
                    const fileLinks = tup.files.map(fileId => {
                      const f = manifest.files[fileId];
                      const title = f ? f.title : fileId;
                      const hasView = f && (f.status === 'migrated' || f.status === 'migrating');
                      if (hasView) {
                        return `<a href="${fileIdToViewPath(fileId)}" class="dep-tag" style="font-size:0.6rem;">${Renderers.escapeHtml(title)}</a>`;
                      }
                      return `<span class="dep-tag" style="font-size:0.6rem;">${Renderers.escapeHtml(title)}</span>`;
                    }).join(' ');

                    const hasFiles = tup.files.length > 0;
                    const allMigrated = tup.files.every(fid => {
                      const f = manifest.files[fid];
                      return f && (f.status === 'migrated' || f.status === 'migrating');
                    });

                    let statusBadge;
                    if (!hasFiles) {
                      statusBadge = '<span class="badge badge-critical">unmapped</span>';
                    } else if (allMigrated) {
                      statusBadge = '<span class="badge badge-success">migrated</span>';
                    } else {
                      statusBadge = '<span class="badge badge-neutral">xlsx only</span>';
                    }

                    return `<tr>
                      <td style="font-weight:600; color:${colors.accent};">${tupCode}</td>
                      <td>${Renderers.escapeHtml(tup.name)}</td>
                      <td>${fileLinks || '<span style="color:var(--text-dim);">No Bootstrap file</span>'}</td>
                      <td>${statusBadge}</td>
                    </tr>`;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>`;
      }

      tupsEl.innerHTML = tupsHtml;

      // ‚îÄ‚îÄ Reconciliation Summary ‚îÄ‚îÄ
      const reconEl = document.getElementById('recon-container');
      let reconHtml = '';

      // Decision distribution
      const decisionCounts = {};
      for (const cluster of Object.values(crosswalk.clusters)) {
        const type = getDecisionType(cluster.decision);
        decisionCounts[type] = (decisionCounts[type] || 0) + 1;
      }

      reconHtml += `
        <div class="card">
          <div class="card-header">
            <span>Decision Distribution</span>
          </div>
          <div class="card-body">
            ${Object.entries(decisionCounts).map(([type, count]) => {
              const badge = DECISION_BADGES[type] || 'badge-neutral';
              const pct = Math.round((count / clusterCount) * 100);
              return `<div style="display:flex; align-items:center; gap:var(--gap-sm); margin-bottom:var(--gap-sm);">
                <span class="badge ${badge}" style="min-width:110px; text-align:center;">${type}</span>
                <div class="progress-bar" style="flex:1;">
                  <div class="progress-fill fill-${type === 'DANILO CANON' ? 'success' : type === 'MERGE' ? 'warning' : type === 'PENDING' ? 'critical' : 'neutral'}" style="width:${pct}%;"></div>
                </div>
                <span style="font-size:var(--font-size-xs); color:var(--text-dim); min-width:40px; text-align:right;">${count} (${pct}%)</span>
              </div>`;
            }).join('')}
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>Coverage Gaps</span>
          </div>
          <div class="card-body">
            <div style="font-size:var(--font-size-xs); color:var(--text-secondary); margin-bottom:var(--gap-sm);">
              <strong style="color:var(--color-warning);">Unmapped TUPs:</strong>
              ${crosswalk.unmapped.tups_without_bootstrap_file.length > 0
                ? crosswalk.unmapped.tups_without_bootstrap_file.map(t => {
                    const tup = crosswalk.tup_to_files[t];
                    return `<span class="badge badge-critical" style="margin-left:var(--gap-xs);">${t}${tup ? ': ' + tup.name : ''}</span>`;
                  }).join('')
                : '<span class="badge badge-success">None</span>'}
            </div>
            <div style="font-size:var(--font-size-xs); color:var(--text-secondary); margin-bottom:var(--gap-sm);">
              <strong style="color:var(--color-warning);">Pending Clusters:</strong>
              ${Object.entries(crosswalk.clusters)
                .filter(([_, c]) => c.decision.includes('PENDING'))
                .map(([id, c]) => `<span class="badge badge-critical" style="margin-left:var(--gap-xs);">${id}: ${c.name}</span>`)
                .join('') || '<span class="badge badge-success">None</span>'}
            </div>
            <div style="font-size:var(--font-size-xs); color:var(--text-secondary);">
              <strong style="color:var(--color-info);">Deferred:</strong>
              ${Object.entries(crosswalk.clusters)
                .filter(([_, c]) => c.decision.includes('DEFER'))
                .map(([id, c]) => `<span class="badge badge-neutral" style="margin-left:var(--gap-xs);">${id}: ${c.name}</span>`)
                .join('') || '<span class="badge badge-success">None</span>'}
            </div>
            <div style="font-size:var(--font-size-xs); color:var(--text-dim); margin-top:var(--gap-md); padding-top:var(--gap-sm); border-top:1px solid var(--border-color);">
              ${Renderers.escapeHtml(crosswalk.unmapped.notes)}
            </div>
          </div>
        </div>
      `;

      // Scope cards (Studio, Funnel ‚Äî out of scope)
      reconHtml += `
        <div class="card" style="grid-column: 1 / -1; border-left: 3px solid var(--color-neutral);">
          <div class="card-header">
            <span>Out-of-Scope Levels</span>
            <span class="badge badge-neutral">DEFERRED</span>
          </div>
          <div class="card-body" style="display:grid; grid-template-columns:1fr 1fr; gap:var(--gap-md);">
            <div>
              <div style="font-size:var(--font-size-sm); font-weight:600; color:var(--text-primary); margin-bottom:var(--gap-xs);">Studio Level (S0-S40)</div>
              <p style="font-size:var(--font-size-xs); color:var(--text-secondary);">41 TUPs covering studio operations, production workflows, and team coordination. Deferred per REC-009 &mdash; revisit when team scales.</p>
            </div>
            <div>
              <div style="font-size:var(--font-size-sm); font-weight:600; color:var(--text-primary); margin-bottom:var(--gap-xs);">Funnel Level (F0-F20)</div>
              <p style="font-size:var(--font-size-xs); color:var(--text-secondary);">21 TUPs covering funnel-specific execution, testing, and optimization. Deferred per REC-010 &mdash; unlocks at funnel build stage.</p>
            </div>
          </div>
        </div>
      `;

      reconEl.innerHTML = reconHtml;
    });
  </script>

</body>
</html>
