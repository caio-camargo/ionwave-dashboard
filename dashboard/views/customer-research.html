<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>03 Customer Research - IonWave</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>

  <header class="header">
    <div class="header-left">
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
        <path d="M2 18 Q7 10 14 14 Q21 18 26 10" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" fill="none"/>
        <path d="M2 14 Q7 6 14 10 Q21 14 26 6" stroke="#22c55e" stroke-width="2" stroke-linecap="round" fill="none" opacity="0.5"/>
      </svg>
      <h1 class="header-title">03 CUSTOMER RESEARCH</h1>
    </div>
    <div class="header-right">
      <div class="header-meta">
        <span class="header-meta-label">Files:</span>
        <span>03A ICP + 03B VOC</span>
      </div>
    </div>
  </header>

  <nav class="nav-bar">
    <a href="../../index.html">Mission Control</a>
    <a href="strategic-foundation.html">01 Strategic Foundation</a>
    <a href="market-intelligence.html">02 Market Intelligence</a>
    <a href="customer-research.html" class="active">03 Customer Research</a>
  </nav>

  <div class="page-content">

    <!-- 03A Section -->
    <div class="section-divider">
      <h2 class="section-title">03A: Customer Research - ICP</h2>
    </div>

    <div id="icp-header"></div>

    <div id="icp-meta" class="section-grid grid-2" style="margin-bottom: var(--gap-lg);">
      <div class="loading">Loading 03A metadata...</div>
    </div>

    <div id="icp-sheets">
      <div class="loading">Loading 03A sheets...</div>
    </div>

    <!-- 03B Section -->
    <div class="section-divider" style="margin-top: var(--gap-xl);">
      <h2 class="section-title">03B: Customer Research - VOC</h2>
    </div>

    <div id="voc-header"></div>

    <div id="voc-meta" class="section-grid grid-2" style="margin-bottom: var(--gap-lg);">
      <div class="loading">Loading 03B metadata...</div>
    </div>

    <div id="voc-sheets">
      <div class="loading">Loading 03B sheets...</div>
    </div>

  </div>

  <footer class="footer">
    IonWave Mission Control &middot; Trade #84 &middot;
    <a href="../index.html">&larr; Back to Mission Control</a>
  </footer>

  <script src="../js/data-loader.js"></script>
  <script src="../js/renderers.js"></script>
  <script>
    async function renderFile(fileId, headerEl, metaEl, sheetsEl) {
      const meta = await DataLoader.loadFileMeta(fileId);
      if (!meta) {
        metaEl.innerHTML = Renderers.emptyState('Failed to load metadata for ' + fileId);
        return;
      }

      headerEl.innerHTML = Renderers.fileHeader(meta);

      let metaHtml = '';
      metaHtml += Renderers.card('Dependencies',
        `<div style="margin-bottom:var(--gap-sm);">
          <span style="font-size:var(--font-size-xs); color:var(--text-dim);">Feeds Into:</span>
          ${Renderers.dependencyTags(meta.feeds_into)}
        </div>
        <div>
          <span style="font-size:var(--font-size-xs); color:var(--text-dim);">Requires:</span>
          ${Renderers.dependencyTags(meta.requires)}
        </div>`
      );
      metaHtml += Renderers.card('Key Blockers',
        `<p style="font-size:var(--font-size-sm); color:var(--text-secondary);">${Renderers.escapeHtml(meta.key_blockers)}</p>
        <p style="font-size:var(--font-size-xs); color:var(--text-dim); margin-top:var(--gap-sm);">
          <strong>Next Action:</strong> ${Renderers.escapeHtml(meta.next_action)}
        </p>`,
        Renderers.statusBadge('draft')
      );

      if (meta.feedback_loops && meta.feedback_loops.length > 0) {
        let loopsHtml = '';
        for (const loop of meta.feedback_loops) {
          loopsHtml += `<div style="padding:var(--gap-sm) 0; border-bottom:1px solid rgba(255,255,255,0.04);">
            <div style="font-size:var(--font-size-xs); color:var(--text-dim);">${Renderers.escapeHtml(loop.from || loop.source || '')}</div>
            <div style="font-size:var(--font-size-sm); color:var(--text-secondary); margin-top:2px;">${Renderers.escapeHtml(loop.tension)}</div>
            <span class="badge badge-warning" style="margin-top:4px;">${loop.status}</span>
          </div>`;
        }
        metaHtml += Renderers.card(`Feedback Loops (${meta.feedback_loops.length})`, loopsHtml);
      }

      if (meta.analysis_summary) {
        let analysisHtml = '';
        if (meta.analysis_summary.archetype_validation) {
          analysisHtml += '<h4 style="font-size:var(--font-size-sm); margin-bottom:var(--gap-sm);">Archetype Validation</h4>';
          analysisHtml += Renderers.table(
            meta.analysis_summary.archetype_validation,
            ['archetype', 'profile', 'voc_status', 'validation', 'grade']
          );
        }
        if (meta.analysis_summary.strategic_implications) {
          analysisHtml += '<h4 style="font-size:var(--font-size-sm); margin-top:var(--gap-md); margin-bottom:var(--gap-sm);">Strategic Implications</h4>';
          analysisHtml += `<ul class="narrative-list">${meta.analysis_summary.strategic_implications.map(s => `<li>${Renderers.escapeHtml(s)}</li>`).join('')}</ul>`;
        }
        metaHtml += Renderers.card('ICP Analysis Summary', analysisHtml);
      }

      metaEl.innerHTML = metaHtml;

      // Load sheets
      const allSheets = await DataLoader.loadAllSheets(fileId);
      let sheetsHtml = '';

      for (const sheetMeta of meta.sheets) {
        const sheetData = allSheets[sheetMeta.id];

        sheetsHtml += `<div class="section-divider">
          <h2 class="section-title" style="font-size:var(--font-size-base);">${Renderers.escapeHtml(sheetMeta.title)}</h2>
        </div>`;

        if (sheetData) {
          sheetsHtml += `<div style="display:flex; gap:var(--gap-sm); align-items:center; margin-bottom:var(--gap-md); font-size:var(--font-size-xs); color:var(--text-dim);">
            <span>Type: ${sheetData._meta.data_type}</span>
            <span>&middot;</span>
            ${Renderers.qualityScore(sheetData._meta.quality_score)}
            <span>&middot;</span>
            ${Renderers.statusBadge(sheetData._meta.status)}
          </div>`;

          sheetsHtml += `<div class="card"><div class="card-body">
            ${Renderers.autoRender(sheetData)}
          </div></div>`;
        } else {
          sheetsHtml += Renderers.emptyState('Sheet data not yet migrated');
        }
      }

      sheetsEl.innerHTML = sheetsHtml;
    }

    document.addEventListener('DOMContentLoaded', async function() {
      // Load both files in parallel
      await Promise.all([
        renderFile(
          '03a_customer_research_icp',
          document.getElementById('icp-header'),
          document.getElementById('icp-meta'),
          document.getElementById('icp-sheets')
        ),
        renderFile(
          '03b_customer_research_voc',
          document.getElementById('voc-header'),
          document.getElementById('voc-meta'),
          document.getElementById('voc-sheets')
        )
      ]);
    });
  </script>

</body>
</html>
